<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    base-uri 'none';
    object-src 'none';
    frame-ancestors 'none';
    connect-src 'self' wss: https:;
    img-src 'self' https: data:;
    script-src 'self' https://esm.sh 'unsafe-inline';
    style-src 'self' 'unsafe-inline';
  ">

  <title>Nostr kind:30000 ユーザリスト編集（nsec PoC）</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --panel2:#fbfbfe;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --line2:#d1d5db;
      --accent:#2563eb;
      --accent2:#1d4ed8;
      --danger:#dc2626;
      --warn:#b45309;
      --ok:#059669;
      --shadow: 0 10px 24px rgba(17,24,39,.08);
      --shadow2: 0 2px 10px rgba(17,24,39,.06);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Hiragino Sans", "Noto Sans JP", "Yu Gothic", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(900px 500px at 15% -10%, rgba(37,99,235,.10), transparent 60%),
        radial-gradient(800px 520px at 95% 0%, rgba(5,150,105,.08), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    .app{max-width: 1180px; margin: 26px auto; padding: 0 16px 56px;}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 14px;}
    .left{display:flex; align-items:center; gap:12px; min-width:0;}
    .back{
      width:40px; height:40px; border-radius: 12px;
      border:1px solid var(--line); background: rgba(255,255,255,.9);
      box-shadow: var(--shadow2);
      cursor:pointer; display:grid; place-items:center;
    }
    .back:hover{border-color: var(--line2)}
    .titlewrap{min-width:0}
    .title{margin:0; font-size: 20px; font-weight: 800; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .subtitle{margin-top:4px; font-size: 12px; color: var(--muted); display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .chip{
      font-size: 12px; padding: 5px 10px; border-radius: 999px;
      border:1px solid var(--line); background: rgba(255,255,255,.75);
      display:inline-flex; gap:8px; align-items:center;
    }
    .chip.mono{font-family: var(--mono)}
    .right{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    .btn{
      border:1px solid var(--line);
      background: #fff;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 700;
      box-shadow: var(--shadow2);
      display:flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{border-color: var(--line2)}
    .btn.primary{
      background: rgba(37,99,235,.10);
      border-color: rgba(37,99,235,.25);
      color: var(--accent2);
    }
    .btn.primary:hover{border-color: rgba(37,99,235,.40)}
    .btn.danger{
      background: rgba(220,38,38,.08);
      border-color: rgba(220,38,38,.25);
      color: var(--danger);
    }
    .btn:disabled{opacity:.45; cursor:not-allowed}

    .grid{display:grid; grid-template-columns: 1fr 380px; gap: 14px; align-items:start;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .panel{
      background: linear-gradient(180deg, #fff, var(--panel2));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .panel .hd h2{
      margin:0; font-size: 13px; letter-spacing:.3px;
      color: var(--muted); font-weight: 850; text-transform: uppercase;
    }
    .panel .bd{padding: 14px;}
    .meta{display:grid; grid-template-columns: 1fr; gap: 10px;}
    .field label{display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; font-weight: 700;}
    .input, .textarea{
      width:100%;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      outline:none;
    }
    .input:focus, .textarea:focus{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }
    .textarea{min-height: 92px; resize: vertical}
    .hint{font-size: 12px; color: var(--muted); line-height: 1.6;}
    .mono{font-family: var(--mono)}

    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-bottom: 10px;
    }
    .toolbarLeft{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .status{font-size: 12px; color: var(--muted); display:flex; align-items:center; gap:8px;}
    .dot{width:10px; height:10px; border-radius: 999px; background: rgba(107,114,128,.25); border:1px solid rgba(107,114,128,.25);}
    .dot.dirty{background: rgba(180,83,9,.65); border-color: rgba(180,83,9,.55)}
    .dot.clean{background: rgba(5,150,105,.65); border-color: rgba(5,150,105,.55)}
    .dot.net{background: rgba(37,99,235,.65); border-color: rgba(37,99,235,.55)}

    .list{display:flex; flex-direction:column; gap: 10px;}
    .row{
      display:grid;
      grid-template-columns: 44px 1fr auto;
      gap: 12px;
      padding: 10px 10px;
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 14px;
      align-items:center;
    }
    .row.pending{opacity:.55; filter:saturate(.7); background: rgba(17,24,39,.02)}
    .avatar{
      width:44px; height:44px; border-radius: 14px;
      border: 1px solid var(--line);
      background: #f3f4f6;
      display:grid; place-items:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .avatar img{width:100%; height:100%; object-fit:cover}

    .main{min-width:0}
    .nameLine{display:flex; align-items:baseline; gap:10px; min-width:0; flex-wrap:wrap;}
    .display{font-weight: 900; font-size: 14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 420px;}
    .handle{color: var(--muted); font-size: 12px;}
    .npubLine{margin-top: 2px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; color: var(--muted); font-size: 12px;}
    .npub{
      font-family: var(--mono);
      border: 1px dashed var(--line2);
      background: rgba(17,24,39,.02);
      padding: 3px 8px;
      border-radius: 999px;
      position: relative;
      cursor: help;
    }
    .npub[data-hex]:hover::after{
      content: attr(data-hex);
      position:absolute;
      left: 0;
      top: calc(100% + 8px);
      z-index: 10;
      white-space: nowrap;
      max-width: min(820px, 80vw);
      overflow:hidden;
      text-overflow: ellipsis;
      font-family: var(--mono);
      font-size: 12px;
      color: #111827;
      background: #fff;
      border: 1px solid var(--line2);
      box-shadow: var(--shadow);
      padding: 8px 10px;
      border-radius: 12px;
    }
    .npub[data-hex]:hover::before{
      content:"";
      position:absolute;
      left: 18px;
      top: calc(100% + 2px);
      width: 10px; height: 10px;
      background: #fff;
      border-left: 1px solid var(--line2);
      border-top: 1px solid var(--line2);
      transform: rotate(45deg);
      z-index: 11;
    }

    .petnameWrap{margin-top: 8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .petnameInput{
      flex: 1 1 460px;
      min-width: 260px;
      height: 36px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      outline:none;
      font-size: 13px;
    }
    .petnameInput:focus{border-color: rgba(37,99,235,.45); box-shadow: 0 0 0 4px rgba(37,99,235,.12);}
    .smallLabel{font-size: 12px; color: var(--muted); font-weight: 800;}

    .rowActions{display:flex; gap:10px; align-items:center;}
    .iconBtn{
      width:38px; height:38px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      box-shadow: var(--shadow2);
      display:grid; place-items:center;
      cursor:pointer;
    }
    .iconBtn:hover{border-color: var(--line2)}
    .iconBtn.danger{
      border-color: rgba(220,38,38,.20);
      background: rgba(220,38,38,.06);
      color: var(--danger);
    }
    .checkbox{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(17,24,39,.02);
      user-select:none;
    }
    .checkbox input{width:16px; height:16px;}
    .checkbox span{font-size: 12px; color: var(--text); font-weight: 750}
    .checkbox small{display:block; font-size: 11px; color: var(--muted); font-weight: 650}

    .footerBar{
      position: sticky;
      bottom: 16px;
      margin-top: 14px;
      display:flex;
      justify-content:space-between;
      gap: 10px;
      padding: 12px;
      background: rgba(255,255,255,.86);
      border: 1px solid var(--line);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .footerLeft{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .footerRight{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;}

    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(17,24,39,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      width: min(820px, 100%);
      border-radius: 18px;
      border: 1px solid var(--line);
      background: #fff;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .mh{
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .modal .mh h3{margin:0; font-size: 14px; color: var(--text); font-weight: 900;}
    .modal .mb{ padding: 14px; }
    .modal .mf{
      padding: 12px 14px 14px;
      border-top: 1px solid var(--line);
      display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;
    }
    .table{width:100%; border-collapse: collapse; font-size: 13px;}
    .table th,.table td{padding: 10px 10px; border-bottom: 1px solid var(--line); vertical-align: top;}
    .table th{color: var(--muted); font-weight:900; text-align:left; font-size: 12px;}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(17,24,39,.02);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
      font-weight: 750;
    }
    .pill.ok{border-color: rgba(5,150,105,.25); background: rgba(5,150,105,.08); color: var(--ok);}
    .pill.ng{border-color: rgba(220,38,38,.25); background: rgba(220,38,38,.06); color: var(--danger);}
    .pill.warn{border-color: rgba(180,83,9,.25); background: rgba(180,83,9,.08); color: var(--warn);}

    .dangerBox{
      border: 1px solid rgba(220,38,38,.25);
      background: rgba(220,38,38,.06);
      border-radius: 14px;
      padding: 10px 12px;
      color: #7f1d1d;
      font-size: 12px;
      line-height: 1.6;
    }
    .okBox{
      border: 1px solid rgba(5,150,105,.20);
      background: rgba(5,150,105,.06);
      border-radius: 14px;
      padding: 10px 12px;
      color: #065f46;
      font-size: 12px;
      line-height: 1.6;
    }
    .divider{height:1px;background:var(--line); margin:12px 0;}

    .screen{display:none;}
    .screen.active{display:block;}

    .cards{display:grid; grid-template-columns: 1fr; gap: 10px;}
    .card{
      border: 1px solid var(--line);
      border-radius: 16px;
      background: #fff;
      box-shadow: var(--shadow2);
      padding: 12px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .card:hover{border-color: var(--line2)}
    .cardMain{min-width:0}
    .cardTitle{font-weight: 900; font-size: 15px; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .cardMeta{margin-top:6px; color: var(--muted); font-size: 12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .cardDesc{margin-top:8px; color: var(--muted); font-size: 12px; line-height: 1.6; white-space:pre-wrap;}
    .cardBtns{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="left">
        <button class="back" title="戻る" id="backBtn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <div class="titlewrap">
          <p class="title" id="pageTitle">kind:30000 リスト一覧</p>
          <div class="subtitle">
            <span class="chip mono" id="pubkeyChip">pubkey: -</span>
            <span class="chip mono" id="npubChip">npub: -</span>
            <span class="chip"><span class="dot net"></span><span id="netText">未接続</span></span>
            <span class="chip"><span class="dot clean" id="dirtyDot"></span><span id="dirtyText">変更なし</span></span>
          </div>
        </div>
      </div>

      <div class="right">
        <button class="btn" id="refreshListsBtn">一覧更新</button>
        <button class="btn primary" id="newListBtn">＋ 新規リスト</button>
      </div>
    </div>

    <div class="screen active" id="screenList">
      <div class="grid">
        <div class="panel">
          <div class="hd">
            <h2>あなたの kind:30000（dごとに最新）</h2>
            <div class="status"><span class="dot clean" id="listDot"></span><span id="listStatus">-</span></div>
          </div>
          <div class="bd">
            <div class="hint" style="margin-bottom:10px">
              同一 d の複数イベントがある場合は created_at 最大を最新として表示します。
            </div>
            <div class="cards" id="listCards"></div>
          </div>
        </div>

        <div class="panel" id="settingsPanelList">
          <div class="hd"><h2>通信 / デバッグ</h2></div>
          <div class="bd">
            <div class="meta">
              <div class="field">
                <label>使用リレー（kind:10002 を優先 / 取得できなければ既定）</label>
                <textarea class="textarea mono" id="relayInput" spellcheck="false"></textarea>
                <div class="hint" style="margin-top:6px">
                  1行に1URL（wss://...）。読み取り/書き込み共通。最大 20 件。<br/>
                  kind:10002 が取れたら自動で置換します（手動編集も可）。
                </div>
              </div>

              <div class="divider"></div>

              <div class="field">
                <label>Debug log（通信ログ）</label>
                <textarea class="textarea mono" id="debugLog" readonly style="min-height:180px"></textarea>
                <div class="hint" style="margin-top:6px">publish/購読/例外などをここに記録します。</div>
              </div>

              <div class="divider"></div>

              <div class="okBox">
                <b>注意</b>：この実装は「nsec を直接入力」します。実運用では推奨しません。<br/>
                入力した nsec は <b>メモリ内のみ</b>で保持し、保存しません。
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="screen" id="screenEdit">
      <div class="grid">
        <div class="panel">
          <div class="hd">
            <h2>エントリ一覧（各エントリの [非公開] で切替）</h2>
            <div class="status">
              <span class="dot clean" id="footerDot"></span>
              <span id="footerStatusText">変更なし</span>
            </div>
          </div>

          <div class="bd">
            <div class="toolbar">
              <div class="toolbarLeft">
                <button class="btn" id="openAddBtn">＋ npub を追加</button>
                <span class="chip mono" id="dTagChip">d: -</span>
                <span class="chip" id="countChip">0 / 1000</span>
                <span class="chip" id="limitStatus">追加可能</span>
              </div>
              <div class="toolbarLeft">
                <button class="btn" id="focusSettingsBtn">リスト情報</button>
                <button class="btn primary" id="publishBtn">反映（publish）</button>
                <button class="btn danger" id="openDeleteBtn">リスト削除</button>
              </div>
            </div>

            <div class="list" id="entryList"></div>

            <div class="hint" style="margin-top:12px">
              変更はブラウザ内メモリに保持され、<b>反映（publish）</b>でリレーへ送信します。
            </div>
          </div>
        </div>

        <div class="panel" id="settingsPanelEdit">
          <div class="hd"><h2>リスト設定 / デバッグ</h2></div>
          <div class="bd">
            <div class="meta">
              <div class="field">
                <label>title（タグ）</label>
                <input class="input" id="titleInput" maxlength="120" placeholder="例）Close friends" />
              </div>

              <div class="field">
                <label>description（タグ）</label>
                <textarea class="textarea" id="descInput" maxlength="2000" placeholder="例）People I trust"></textarea>
              </div>

              <div class="field">
                <label>d（固定ID）</label>
                <input class="input mono" id="dInput" maxlength="120" placeholder="例）friends" />
                <div class="hint" style="margin-top:6px">
                  編集画面では d を固定扱いにする想定です（PoCのため入力は可能ですが、変更は推奨しません）。
                </div>
              </div>

              <div class="divider"></div>

              <div class="field">
                <label>Debug log（通信ログ）</label>
                <textarea class="textarea mono" id="debugLog2" readonly style="min-height:180px"></textarea>
                <div class="hint" style="margin-top:6px">publish/購読/例外などをここに記録します。</div>
              </div>

              <div class="divider"></div>

              <div class="hint">
                petname が未入力のときは <b>空欄</b>のまま保持します（プロフィール名で自動補完しません）。
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="footerBar">
        <div class="footerLeft">
          <div class="status">
            <span class="dot clean" id="footerDot2"></span>
            <span id="footerStatusText2">変更なし</span>
          </div>
          <span class="chip" id="limitStatus2">追加可能</span>
        </div>
        <div class="footerRight">
          <button class="btn" id="openAddBtn2">＋ 追加</button>
          <button class="btn primary" id="publishBtn2">反映（publish）</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modalOverlay" id="loginModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="mh">
        <h3>ログイン（nsec）</h3>
      </div>
      <div class="mb">
        <div class="dangerBox">
          <b>重要</b>：nsec の直接入力は危険です。PoC 用に限定し、普段使いの鍵は使わないでください。<br/>
          入力は保存しません（リロードで消えます）。
        </div>

        <div class="divider"></div>

        <div class="field">
          <label>nsec（bech32）</label>
          <input class="input mono" id="nsecInput" placeholder="nsec1..." autocomplete="off" />
        </div>

        <div class="field" style="margin-top:10px">
          <label>初期 d（編集対象のリストID）</label>
          <input class="input mono" id="initialD" placeholder="例）friends" value="friends" />
          <div class="hint" style="margin-top:6px">
            （任意）ログイン直後にこの d を開きます。空なら一覧画面へ進みます。
          </div>
        </div>
      </div>
      <div class="mf">
        <button class="btn primary" id="loginBtn">接続して読み込む</button>
      </div>
    </div>
  </div>

  <div class="modalOverlay" id="newListModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="mh">
        <h3>新規リスト作成</h3>
        <button class="iconBtn" id="closeNewListBtn" title="閉じる">✕</button>
      </div>
      <div class="mb">
        <div class="field">
          <label>d（必須 / 重複不可）</label>
          <input class="input mono" id="newDInput" placeholder="例）friends" maxlength="120" />
          <div class="hint" style="margin-top:6px">同一 pubkey の既存 kind:30000 に同じ d があればエラーにします。</div>
        </div>
        <div class="field" style="margin-top:12px">
          <label>title（任意）</label>
          <input class="input" id="newTitleInput" placeholder="例）Close friends" maxlength="120" />
        </div>
        <div class="field" style="margin-top:12px">
          <label>description（任意）</label>
          <textarea class="textarea" id="newDescInput" placeholder="例）People I trust" maxlength="2000"></textarea>
        </div>
      </div>
      <div class="mf">
        <button class="btn" id="cancelNewListBtn">キャンセル</button>
        <button class="btn primary" id="createNewListBtn">作成して編集へ</button>
      </div>
    </div>
  </div>

  <div class="modalOverlay" id="addModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="mh">
        <h3>npub を追加</h3>
        <button class="iconBtn" id="closeAddBtn" title="閉じる">✕</button>
      </div>
      <div class="mb">
        <div class="field">
          <label>npub を貼り付け</label>
          <input class="input mono" id="npubInput" placeholder="npub1..." autocomplete="off" />
        </div>

        <div class="field" style="margin-top:12px">
          <label>petname（エントリ説明 / 任意）</label>
          <input class="input" id="petnameInput" maxlength="200" placeholder="（空欄でOK）" />
          <div class="hint" style="margin-top:6px">
            ※空欄の場合は空欄のまま保持します（プロフィール名を自動入力しません）
          </div>
        </div>

        <div class="divider"></div>

        <div id="previewBox" style="display:none">
          <div class="row" style="grid-template-columns:44px 1fr;">
            <div class="avatar" id="prevAvatar"></div>
            <div class="main">
              <div class="nameLine">
                <div class="display" id="prevDisplay">—</div>
                <div class="handle" id="prevHandle">@—</div>
              </div>
              <div class="npubLine">
                <span class="npub mono" id="prevNpub" data-hex="">npub…</span>
                <span class="hint">（hex はホバーで表示）</span>
              </div>
            </div>
          </div>
        </div>

        <div class="hint" style="margin-top:10px">
          追加済み（同一公開鍵）の場合は拒否します。上限は 1,000 件です。
        </div>
      </div>
      <div class="mf">
        <button class="btn" id="cancelAddBtn">キャンセル</button>
        <button class="btn primary" id="previewBtn">プレビュー（kind:0）</button>
        <button class="btn primary" id="addBtn" disabled>追加</button>
      </div>
    </div>
  </div>

  <div class="modalOverlay" id="publishModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="mh">
        <h3>publish 結果</h3>
        <button class="iconBtn" id="closePublishBtn" title="閉じる">✕</button>
      </div>
      <div class="mb">
        <div class="hint" style="margin-bottom:10px">
          リレー別の成否を表示します（成功/失敗/タイムアウト）。
        </div>
        <table class="table" id="relayTable">
          <thead><tr><th>Relay</th><th>結果</th><th>備考</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="mf">
        <button class="btn" id="closePublishBtn2">閉じる</button>
      </div>
    </div>
  </div>

  <div class="modalOverlay" id="deleteListModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="mh">
        <h3>リスト削除（kind:5）</h3>
        <button class="iconBtn" id="closeDeleteBtn" title="閉じる">✕</button>
      </div>
      <div class="mb">
        <div class="hint">
          kind:5 の削除イベントで <span class="chip mono">a</span> と <span class="chip mono">k</span> を付与して削除要求します。<br/>
          ※完全削除はリレー実装に依存します。
        </div>
        <div class="divider"></div>
        <div class="field">
          <label>削除対象 a（自動生成）</label>
          <input class="input mono" id="deleteA" readonly />
        </div>
        <div class="divider"></div>
        <div class="hint" style="margin-bottom:8px">各リレーへ削除要求を送信します。</div>
        <table class="table" id="deleteRelayTable">
          <thead><tr><th>Relay</th><th>結果</th><th>備考</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="mf">
        <button class="btn" id="closeDeleteBtn2">閉じる</button>
        <button class="btn danger" id="deleteBtn">削除イベントを発行</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { SimplePool, getPublicKey, finalizeEvent, nip19, nip04 } from "https://esm.sh/nostr-tools@2.7.2";

    const LIMITS = { maxEntries: 1000, maxPetname: 200, maxTitle: 120, maxDesc: 2000, maxRelays: 20, maxTagLen: 500, maxContentLen: 40000 };

    const pool = new SimplePool();
    let sk = null, pkHex = null, npub = null;

    const profileCache = new Map();
    const listIndex = new Map();
    const existingDs = new Set();

    let dirty = false;
    const state = { d: "", title: "", description: "", entries: [] };

    const BOOTSTRAP_RELAYS = [
      "wss://relay.damus.io",
      "wss://yabu.me"
    ];

    const pageTitle = document.getElementById("pageTitle");
    const pubkeyChip = document.getElementById("pubkeyChip");
    const npubChip = document.getElementById("npubChip");
    const netText = document.getElementById("netText");
    const dirtyDot = document.getElementById("dirtyDot");
    const dirtyText = document.getElementById("dirtyText");

    const screenList = document.getElementById("screenList");
    const screenEdit = document.getElementById("screenEdit");

    const relayInput = document.getElementById("relayInput");
    const debugLogEl = document.getElementById("debugLog");
    const debugLogEl2 = document.getElementById("debugLog2");

    const listCards = document.getElementById("listCards");
    const listDot = document.getElementById("listDot");
    const listStatus = document.getElementById("listStatus");
    const refreshListsBtn = document.getElementById("refreshListsBtn");
    const newListBtn = document.getElementById("newListBtn");

    const entryList = document.getElementById("entryList");
    const countChip = document.getElementById("countChip");
    const limitStatus = document.getElementById("limitStatus");
    const limitStatus2 = document.getElementById("limitStatus2");
    const footerDot = document.getElementById("footerDot");
    const footerDot2 = document.getElementById("footerDot2");
    const footerStatusText = document.getElementById("footerStatusText");
    const footerStatusText2 = document.getElementById("footerStatusText2");
    const dTagChip = document.getElementById("dTagChip");
    const titleInput = document.getElementById("titleInput");
    const descInput = document.getElementById("descInput");
    const dInput = document.getElementById("dInput");

    const loginModal = document.getElementById("loginModal");
    const loginBtn = document.getElementById("loginBtn");
    const nsecInput = document.getElementById("nsecInput");
    const initialD = document.getElementById("initialD");

    const newListModal = document.getElementById("newListModal");
    const closeNewListBtn = document.getElementById("closeNewListBtn");
    const cancelNewListBtn = document.getElementById("cancelNewListBtn");
    const createNewListBtn = document.getElementById("createNewListBtn");
    const newDInput = document.getElementById("newDInput");
    const newTitleInput = document.getElementById("newTitleInput");
    const newDescInput = document.getElementById("newDescInput");

    const addModal = document.getElementById("addModal");
    const closeAddBtn = document.getElementById("closeAddBtn");
    const cancelAddBtn = document.getElementById("cancelAddBtn");
    const previewBtn = document.getElementById("previewBtn");
    const addBtn = document.getElementById("addBtn");
    const npubInput = document.getElementById("npubInput");
    const petnameInput = document.getElementById("petnameInput");
    const previewBox = document.getElementById("previewBox");
    const prevAvatar = document.getElementById("prevAvatar");
    const prevDisplay = document.getElementById("prevDisplay");
    const prevHandle = document.getElementById("prevHandle");
    const prevNpub = document.getElementById("prevNpub");

    const publishModal = document.getElementById("publishModal");
    const relayTableBody = document.querySelector("#relayTable tbody");
    const closePublishBtn = document.getElementById("closePublishBtn");
    const closePublishBtn2 = document.getElementById("closePublishBtn2");

    const deleteListModal = document.getElementById("deleteListModal");
    const closeDeleteBtn = document.getElementById("closeDeleteBtn");
    const closeDeleteBtn2 = document.getElementById("closeDeleteBtn2");
    const deleteBtn = document.getElementById("deleteBtn");
    const deleteA = document.getElementById("deleteA");
    const deleteRelayBody = document.querySelector("#deleteRelayTable tbody");

    const backBtn = document.getElementById("backBtn");
    const focusSettingsBtn = document.getElementById("focusSettingsBtn");
    const openAddBtn = document.getElementById("openAddBtn");
    const openAddBtn2 = document.getElementById("openAddBtn2");
    const publishBtn = document.getElementById("publishBtn");
    const publishBtn2 = document.getElementById("publishBtn2");
    const openDeleteBtn = document.getElementById("openDeleteBtn");

    function safeJson(obj){ try { return JSON.stringify(obj); } catch { return "[unserializable]"; } }
    function debugLog(msg, obj){
      const ts = new Date().toISOString();
      const line = obj ? `${ts} ${msg} ${safeJson(obj)}` : `${ts} ${msg}`;
      console.log(line, obj ?? "");
      if (debugLogEl) debugLogEl.value = line + "\n" + debugLogEl.value;
      if (debugLogEl2) debugLogEl2.value = line + "\n" + debugLogEl2.value;
    }

    function setNetStatus(txt){ netText.textContent = txt; }
    function openModal(id){ document.getElementById(id).style.display = "flex"; }
    function closeModal(id){ document.getElementById(id).style.display = "none"; }
    function showLogin(){ loginModal.style.display = "flex"; }
    function hideLogin(){ loginModal.style.display = "none"; }

    function switchScreen(which){
      screenList.classList.toggle("active", which === "list");
      screenEdit.classList.toggle("active", which === "edit");
      pageTitle.textContent = (which === "list") ? "kind:30000 リスト一覧" : "kind:30000 リスト編集";
      backBtn.style.visibility = (which === "edit") ? "visible" : "hidden";
    }

    for(const id of ["addModal","publishModal","deleteListModal","newListModal"]){
      const el = document.getElementById(id);
      el.addEventListener("click", (ev) => { if(ev.target === el) closeModal(id); });
    }

    function markDirty(v){ dirty = v; updateDirtyUI(); }
    function updateDirtyUI(){
      const isDirty = dirty;
      dirtyDot.className = "dot " + (isDirty ? "dirty" : "clean");
      dirtyText.textContent = isDirty ? "変更あり" : "変更なし";
      footerDot.className = "dot " + (isDirty ? "dirty" : "clean");
      footerDot2.className = footerDot.className;
      footerStatusText.textContent = isDirty ? "変更あり（反映待ち）" : "変更なし";
      footerStatusText2.textContent = footerStatusText.textContent;
    }

    function clampStr(s, max){ if(typeof s !== "string") return ""; return s.length <= max ? s : s.slice(0, max); }

    function sanitizeImageUrl(url){
      if(!url) return "";
      try{
        const u = new URL(url, location.origin);
        if(u.protocol === "https:") return u.toString();
        return "";
      }catch{
        if(url.startsWith("data:image/")){
          const head = url.slice(0, 40).toLowerCase();
          if(head.startsWith("data:image/png") || head.startsWith("data:image/jpeg") || head.startsWith("data:image/jpg") ||
             head.startsWith("data:image/webp") || head.startsWith("data:image/gif")){
            return url;
          }
        }
        return "";
      }
    }

    function normalizeRelayUrls(raw){
      const lines = raw.split("\n").map(s => s.trim()).filter(Boolean);
      const uniq = [];
      const seen = new Set();
      for(const line of lines){
        if(uniq.length >= LIMITS.maxRelays) break;
        let u; try{ u = new URL(line); }catch{ continue; }
        if(u.protocol !== "wss:" && u.protocol !== "ws:") continue;
        u.hash = ""; u.search = "";
        const normalized = u.toString().replace(/\/+$/,"");
        if(seen.has(normalized)) continue;
        seen.add(normalized);
        uniq.push(normalized);
      }
      return uniq;
    }
    function setRelayUrls(urls){
      const norm = normalizeRelayUrls(urls.join("\n"));
      relayInput.value = norm.join("\n");
    }
    function getRelayUrls(){
      const norm = normalizeRelayUrls(relayInput.value);
      return norm.length ? norm : BOOTSTRAP_RELAYS;
    }

    function nowSec(){ return Math.floor(Date.now()/1000); }

    function bech32ToSk(nsec){
      const decoded = nip19.decode(nsec);
      if(decoded.type !== "nsec") throw new Error("nsec ではありません");
      return decoded.data;
    }
    function pubkeyToNpub(hex){ return nip19.npubEncode(hex); }
    function decodeNpubToHex(npubStr){
      const decoded = nip19.decode(npubStr);
      if(decoded.type !== "npub") throw new Error("npub ではありません");
      return decoded.data;
    }
    function safeNpub(hex){ try { return pubkeyToNpub(hex); } catch { return ""; } }
    function safeShort(s, n){
      if(!s) return "";
      if(s.length <= n) return s;
      const k = Math.max(6, Math.floor((n - 3) / 2));
      return s.slice(0, k) + "..." + s.slice(-k);
    }

    function buildPTag(hex, relayHint, petname){ return ["p", hex, relayHint ?? "", petname ?? ""]; }

    async function encryptPrivatePTags(privatePTags){
      const plaintext = JSON.stringify(privatePTags);
      return await nip04.encrypt(sk, pkHex, plaintext);
    }
    async function decryptPrivatePTags(content){
      if(!content) return [];
      if(content.length > LIMITS.maxContentLen) return [];
      try{
        const plaintext = await nip04.decrypt(sk, pkHex, content);
        const parsed = JSON.parse(plaintext);
        return Array.isArray(parsed) ? parsed : [];
      }catch{ return []; }
    }

    async function fetchMany(filter, relays, timeoutMs){
      const urls = relays.length ? relays : BOOTSTRAP_RELAYS;
      debugLog("subscribeMany", { relays: urls, filter });

      const out = [];
      const seen = new Set();
      return await new Promise((resolve) => {
        let done = false;
        const sub = pool.subscribeMany(urls, [filter], {
          onevent(ev){
            if(!ev || !ev.id) return;
            if(seen.has(ev.id)) return;
            seen.add(ev.id);
            out.push(ev);
          },
          oneose(){
            if(done) return;
            done = true;
            try{ sub.close(); }catch{}
            resolve(out);
          }
        });

        setTimeout(() => {
          if(done) return;
          done = true;
          try{ sub.close(); }catch{}
          resolve(out);
        }, timeoutMs);
      });
    }
    async function fetchOne(filter, relays, timeoutMs){
      const evs = await fetchMany(filter, relays, timeoutMs);
      if(evs.length === 0) return null;
      evs.sort((a,b) => (b.created_at||0) - (a.created_at||0));
      return evs[0];
    }

    function withTimeout(promise, ms, label) {
      return Promise.race([
        promise,
        new Promise((_, reject) => setTimeout(() => reject(new Error(`timeout(${label})`)), ms))
      ]);
    }
    async function publishToRelays(ev, relays) {
      const timeoutMs = 8000;
      debugLog("publish: start", { id: ev.id, kind: ev.kind, relays });
      const pubs = pool.publish(relays, ev);
      const results = await Promise.allSettled(
        pubs.map((p, i) => withTimeout(p, timeoutMs, relays[i]).then(
          (okVal) => ({ url: relays[i], ok: true, note: String(okVal ?? "ok") }),
          (err)   => ({ url: relays[i], ok: false, note: (err?.message || String(err)) })
        ))
      );
      const normalized = results.map((r) => r.status === "fulfilled" ? r.value : ({ url:"unknown", ok:false, note:(r.reason?.message||String(r.reason)) }));
      debugLog("publish: done", normalized);
      return normalized;
    }

    async function loadKind10002Relays(){
      const relays = getRelayUrls();
      const ev = await fetchOne({ kinds:[10002], authors:[pkHex], limit: 1 }, relays, 2500);
      if(!ev) return;
      const relayTags = (ev.tags || []).filter(t => Array.isArray(t) && t[0] === "r" && t[1]);
      const joined = relayTags.map(t => String(t[1])).join("\n");
      const normalized = normalizeRelayUrls(joined);
      if(normalized.length){
        debugLog("kind:10002 relays applied", normalized);
        setRelayUrls(normalized);
      }
    }

    async function loadAllLists(){
      if(!pkHex) return;
      listDot.className = "dot net";
      listStatus.textContent = "読み込み中…";
      listIndex.clear();
      existingDs.clear();

      const relays = getRelayUrls();
      const evs = await fetchMany({ kinds:[30000], authors:[pkHex], limit: 200 }, relays, 4000);

      for(const ev of evs){
        const tags = Array.isArray(ev.tags) ? ev.tags : [];
        const d = tags.find(t => Array.isArray(t) && t[0]==="d")?.[1];
        if(!d) continue;
        existingDs.add(String(d));

        const current = listIndex.get(String(d));
        const created = ev.created_at || 0;
        if(!current || created > (current.created_at||0)){
          const title = tags.find(t => Array.isArray(t) && t[0]==="title")?.[1] || "";
          const desc = tags.find(t => Array.isArray(t) && t[0]==="description")?.[1] || "";
          listIndex.set(String(d), { event: ev, d: String(d), title: String(title||""), description: String(desc||""), created_at: created, id: ev.id });
        }
      }

      renderListCards();
      listDot.className = "dot clean";
      listStatus.textContent = `d=${listIndex.size} 件`;
      debugLog("lists loaded", { count: listIndex.size });
    }

    function renderListCards(){
      listCards.innerHTML = "";
      const items = Array.from(listIndex.values()).sort((a,b) => (b.created_at||0) - (a.created_at||0));
      if(items.length === 0){
        const p = document.createElement("div");
        p.className = "hint";
        p.textContent = "まだ kind:30000 が見つかりません。右上の「＋ 新規リスト」で作成できます。";
        listCards.appendChild(p);
        return;
      }
      for(const it of items){
        const card = document.createElement("div");
        card.className = "card";

        const main = document.createElement("div");
        main.className = "cardMain";

        const t = document.createElement("p");
        t.className = "cardTitle";
        t.textContent = it.title ? it.title : it.d;

        const meta = document.createElement("div");
        meta.className = "cardMeta";

        const chipD = document.createElement("span");
        chipD.className = "chip mono";
        chipD.textContent = "d: " + it.d;

        const chipTime = document.createElement("span");
        chipTime.className = "chip";
        chipTime.textContent = "updated: " + new Date((it.created_at||0)*1000).toLocaleString();

        const chipId = document.createElement("span");
        chipId.className = "chip mono";
        chipId.textContent = "id: " + safeShort(it.id, 16);

        meta.appendChild(chipD);
        meta.appendChild(chipTime);
        meta.appendChild(chipId);

        main.appendChild(t);
        main.appendChild(meta);

        if(it.description){
          const d = document.createElement("div");
          d.className = "cardDesc";
          d.textContent = clampStr(it.description, 240);
          main.appendChild(d);
        }

        const btns = document.createElement("div");
        btns.className = "cardBtns";

        const edit = document.createElement("button");
        edit.className = "btn primary";
        edit.textContent = "編集";
        edit.addEventListener("click", async () => { await openEditorFromEvent(it.event); });

        btns.appendChild(edit);

        card.appendChild(main);
        card.appendChild(btns);
        listCards.appendChild(card);
      }
    }

    async function openEditorFromEvent(ev){
      await hydrateStateFromEvent(ev);
      switchScreen("edit");
      markDirty(false);
    }
    async function openEditorEmpty(d, title, desc){
      state.d = d;
      state.title = title || d;
      state.description = desc || "";
      state.entries = [];
      renderEditAll();
      switchScreen("edit");
      markDirty(false);
    }

    async function hydrateStateFromEvent(ev){
      const tags = Array.isArray(ev.tags) ? ev.tags : [];
      const safeTags = tags
        .filter(t => Array.isArray(t) && typeof t[0] === "string")
        .map(t => t.map(x => clampStr(String(x ?? ""), LIMITS.maxTagLen)));

      const dTag = safeTags.find(t => t[0] === "d")?.[1] || "";
      const title = safeTags.find(t => t[0] === "title")?.[1] || "";
      const desc = safeTags.find(t => t[0] === "description")?.[1] || "";

      const publicPTags = safeTags.filter(t => t[0] === "p");
      const privatePTags = await decryptPrivatePTags(String(ev.content || ""));

      const entries = [];

      for(const pt of publicPTags){
        const hex = pt[1] || "";
        if(!hex) continue;
        const petname = clampStr(pt[3] || "", LIMITS.maxPetname);
        entries.push({ hex, npub: safeNpub(hex), display:"(loading...)", name:"", avatar:"", petname, relayHint: pt[2]||"", isPrivate:false, pendingDelete:false });
      }

      for(const pt of privatePTags){
        if(!Array.isArray(pt) || pt[0] !== "p") continue;
        const hex = String(pt[1] || "");
        if(!hex) continue;
        const relayHint = String(pt[2] || "");
        const petname = clampStr(String(pt[3] || ""), LIMITS.maxPetname);
        entries.push({ hex, npub: safeNpub(hex), display:"(loading...)", name:"", avatar:"", petname, relayHint, isPrivate:true, pendingDelete:false });
      }

      const seen = new Set();
      const deduped = [];
      for(const e of entries){ if(seen.has(e.hex)) continue; seen.add(e.hex); deduped.push(e); }

      state.d = clampStr(dTag || state.d, LIMITS.maxTitle);
      state.title = clampStr(title, LIMITS.maxTitle);
      state.description = clampStr(desc, LIMITS.maxDesc);
      state.entries = deduped.slice(0, LIMITS.maxEntries);

      await fetchProfilesForEntries();
      renderEditAll();
      debugLog("editor hydrated", { d: state.d, entries: state.entries.length });
    }

    async function fetchProfilesForEntries(){
      const relays = getRelayUrls();
      const need = state.entries.map(e => e.hex).filter(hex => !profileCache.has(hex));
      if(need.length === 0){ applyProfiles(); return; }

      const chunkSize = 50;
      for(let i=0;i<need.length;i+=chunkSize){
        const chunk = need.slice(i, i+chunkSize);
        const evs = await fetchMany({ kinds:[0], authors: chunk, limit: chunk.length }, relays, 2500);
        for(const ev of evs){
          try{
            const obj = JSON.parse(String(ev.content || "{}"));
            profileCache.set(ev.pubkey, obj);
          }catch{}
        }
      }
      applyProfiles();
    }

    function applyProfiles(){
      for(const e of state.entries){
        const p = profileCache.get(e.hex);
        if(!p) continue;
        e.display = clampStr(String(p.display_name || p.name || "(no name)"), 120);
        e.name = clampStr(String(p.name || ""), 80);
        e.avatar = sanitizeImageUrl(typeof p.picture === "string" ? p.picture : "");
      }
    }

    function makeImg(src){
      const img = document.createElement("img");
      img.alt = "";
      img.loading = "lazy";
      img.decoding = "async";
      img.referrerPolicy = "no-referrer";
      img.src = src;
      return img;
    }

    function renderEditAll(){
      dTagChip.textContent = "d: " + (state.d || "-");
      dInput.value = state.d || "";
      titleInput.value = state.title || "";
      descInput.value = state.description || "";

      entryList.innerHTML = "";
      for(const e of state.entries){ entryList.appendChild(renderRow(e)); }

      const count = state.entries.length;
      countChip.textContent = `${count} / ${LIMITS.maxEntries}`;
      const atLimit = count >= LIMITS.maxEntries;
      limitStatus.textContent = atLimit ? "上限（1,000件）" : "追加可能";
      limitStatus2.textContent = limitStatus.textContent;

      updateDirtyUI();
    }

    function renderRow(e){
      const row = document.createElement("div");
      row.className = "row" + (e.pendingDelete ? " pending" : "");

      const av = document.createElement("div");
      av.className = "avatar";
      const fallback = "data:image/svg+xml;utf8," + encodeURIComponent(svgAvatar("#9ca3af","?"));
      av.appendChild(makeImg(e.avatar || fallback));

      const main = document.createElement("div");
      main.className = "main";

      const nameLine = document.createElement("div");
      nameLine.className = "nameLine";

      const display = document.createElement("div");
      display.className = "display";
      display.textContent = e.display || "(no display)";

      const handle = document.createElement("div");
      handle.className = "handle";
      handle.textContent = "@" + (e.name || "unknown");

      nameLine.appendChild(display);
      nameLine.appendChild(handle);

      const npubLine = document.createElement("div");
      npubLine.className = "npubLine";

      const npubSpan = document.createElement("span");
      npubSpan.className = "npub mono";
      npubSpan.textContent = safeShort(e.npub || ("npub?:" + e.hex), 52);
      npubSpan.setAttribute("data-hex", e.hex);
      npubLine.appendChild(npubSpan);

      if(e.pendingDelete){
        const pill = document.createElement("span");
        pill.className = "pill warn";
        pill.textContent = "削除予定";
        npubLine.appendChild(pill);
      }

      const petWrap = document.createElement("div");
      petWrap.className = "petnameWrap";

      const petLabel = document.createElement("span");
      petLabel.className = "smallLabel";
      petLabel.textContent = "petname";

      const petInput = document.createElement("input");
      petInput.className = "petnameInput";
      petInput.value = clampStr(e.petname || "", LIMITS.maxPetname);
      petInput.maxLength = LIMITS.maxPetname;
      petInput.placeholder = "（空欄でOK）";
      petInput.disabled = e.pendingDelete;
      petInput.addEventListener("input", () => { e.petname = clampStr(petInput.value, LIMITS.maxPetname); markDirty(true); });

      petWrap.appendChild(petLabel);
      petWrap.appendChild(petInput);

      main.appendChild(nameLine);
      main.appendChild(npubLine);
      main.appendChild(petWrap);

      const actions = document.createElement("div");
      actions.className = "rowActions";

      const cb = document.createElement("label");
      cb.className = "checkbox";
      cb.title = "チェックすると非公開（暗号化して content に格納）";
      const inp = document.createElement("input");
      inp.type = "checkbox";
      inp.checked = !!e.isPrivate;
      inp.disabled = e.pendingDelete;
      inp.addEventListener("change", () => { e.isPrivate = inp.checked; markDirty(true); renderEditAll(); });

      const txtWrap = document.createElement("div");
      const t1 = document.createElement("span");
      t1.textContent = "非公開";
      const t2 = document.createElement("small");
      t2.textContent = e.isPrivate ? "content（暗号化）" : "tags（公開）";
      txtWrap.appendChild(t1);
      txtWrap.appendChild(t2);

      cb.appendChild(inp);
      cb.appendChild(txtWrap);

      const trash = document.createElement("button");
      trash.className = "iconBtn danger";
      trash.title = e.pendingDelete ? "削除を取り消す" : "削除予定にする";
      trash.textContent = e.pendingDelete ? "↩" : "🗑";
      trash.addEventListener("click", () => { e.pendingDelete = !e.pendingDelete; markDirty(true); renderEditAll(); });

      actions.appendChild(cb);
      actions.appendChild(trash);

      row.appendChild(av);
      row.appendChild(main);
      row.appendChild(actions);
      return row;
    }

    function buildKind30000Event(){
      const kept = state.entries.filter(e => !e.pendingDelete);
      const publicTags = [];
      const privateTags = [];
      for(const e of kept){
        const pet = clampStr(e.petname || "", LIMITS.maxPetname);
        const pt = buildPTag(e.hex, e.relayHint ?? "", pet);
        if(e.isPrivate) privateTags.push(pt);
        else publicTags.push(pt);
      }
      const tags = [
        ["d", state.d],
        ["title", (state.title || state.d).slice(0, LIMITS.maxTitle)],
        ...(state.description ? [["description", state.description.slice(0, LIMITS.maxDesc)]] : []),
        ...publicTags
      ];
      return { tags, privateTags };
    }

    async function publishNow(){
      if(!sk || !pkHex){ alert("未ログインです。"); return; }

      state.d = clampStr((dInput.value || "").trim(), LIMITS.maxTitle);
      state.title = clampStr((titleInput.value || "").trim(), LIMITS.maxTitle);
      state.description = clampStr((descInput.value || "").trim(), LIMITS.maxDesc);

      if(!state.d){ alert("d が空です。"); return; }
      if(state.entries.length > LIMITS.maxEntries){ alert("エントリが 1,000 件を超えています。削除してから反映してください。"); return; }

      const relays = getRelayUrls();
      const { tags, privateTags } = buildKind30000Event();
      const content = privateTags.length ? await encryptPrivatePTags(privateTags) : "";

      const unsigned = { kind: 30000, created_at: nowSec(), tags, content };
      const ev = finalizeEvent(unsigned, sk);

      debugLog("publishNow: relays", relays);
      debugLog("publishNow: event summary", { id: ev.id, kind: ev.kind, created_at: ev.created_at, tags_count: ev.tags?.length ?? 0, content_len: (ev.content || "").length });

      relayTableBody.innerHTML = "";
      openModal("publishModal");

      const results = await publishToRelays(ev, relays);
      results.sort((a,b) => a.url.localeCompare(b.url));

      for(const r of results){
        const tr = document.createElement("tr");

        const td1 = document.createElement("td");
        const chip = document.createElement("span");
        chip.className = "chip mono";
        chip.textContent = r.url;
        td1.appendChild(chip);

        const td2 = document.createElement("td");
        const pill = document.createElement("span");
        pill.className = "pill " + (r.ok ? "ok" : "ng");
        pill.textContent = r.ok ? "成功" : "失敗";
        td2.appendChild(pill);

        const td3 = document.createElement("td");
        td3.className = "hint";
        td3.textContent = r.note || "";

        tr.appendChild(td1);
        tr.appendChild(td2);
        tr.appendChild(td3);
        relayTableBody.appendChild(tr);
      }

      state.entries = state.entries.filter(e => !e.pendingDelete);
      await fetchProfilesForEntries();
      renderEditAll();
      markDirty(false);

      await loadAllLists();
    }

    function buildDeleteEvent(){
      const a = `30000:${pkHex}:${state.d}`;
      const unsigned = { kind: 5, created_at: nowSec(), tags: [["a", a], ["k", "30000"]], content: "" };
      const ev = finalizeEvent(unsigned, sk);
      return { ev, a };
    }

    async function openDeleteListModal(){
      if(!pkHex){ alert("未ログインです。"); return; }
      state.d = clampStr((dInput.value || state.d || "").trim(), LIMITS.maxTitle);
      if(!state.d){ alert("d が空です。"); return; }
      const { a } = buildDeleteEvent();
      deleteA.value = a;
      deleteRelayBody.innerHTML = "";
      openModal("deleteListModal");
    }

    deleteBtn.addEventListener("click", async () => {
      const relays = getRelayUrls();
      const { ev } = buildDeleteEvent();
      deleteRelayBody.innerHTML = "";
      const results = await publishToRelays(ev, relays);
      results.sort((a,b) => a.url.localeCompare(b.url));

      for(const r of results){
        const tr = document.createElement("tr");

        const td1 = document.createElement("td");
        const chip = document.createElement("span");
        chip.className = "chip mono";
        chip.textContent = r.url;
        td1.appendChild(chip);

        const td2 = document.createElement("td");
        const pill = document.createElement("span");
        pill.className = "pill " + (r.ok ? "ok" : "ng");
        pill.textContent = r.ok ? "成功" : "失敗";
        td2.appendChild(pill);

        const td3 = document.createElement("td");
        td3.className = "hint";
        td3.textContent = r.note || "";

        tr.appendChild(td1);
        tr.appendChild(td2);
        tr.appendChild(td3);
        deleteRelayBody.appendChild(tr);
      }

      await loadAllLists();
    });

    let addDraft = { hex:null, npub:null, profile:null };
    function resetAddModal(){
      npubInput.value = "";
      petnameInput.value = "";
      previewBox.style.display = "none";
      addBtn.disabled = true;
      addDraft = { hex:null, npub:null, profile:null };
    }

    function makeFallback(color){
      return "data:image/svg+xml;utf8," + encodeURIComponent(svgAvatar(color,"?"));
    }

    previewBtn.addEventListener("click", async () => {
      const npubStr = (npubInput.value || "").trim();
      if(!npubStr){ alert("npub を入力してください。"); return; }

      let hex;
      try{ hex = decodeNpubToHex(npubStr); }
      catch{ alert("npub の形式が不正です。"); return; }

      const exists = state.entries.some(e => e.hex === hex && !e.pendingDelete);
      if(exists){ alert("追加済みです（同一公開鍵）。"); previewBox.style.display = "none"; addBtn.disabled = true; return; }

      if(state.entries.length >= LIMITS.maxEntries){ alert("上限（1,000件）に達しています。削除のみ可能です。"); previewBox.style.display = "none"; addBtn.disabled = true; return; }

      const relays = getRelayUrls();
      const ev = await fetchOne({ kinds:[0], authors:[hex], limit: 1 }, relays, 2500);

      let display = "(no name)", name = "", picture = "";
      if(ev){
        try{
          const p = JSON.parse(String(ev.content || "{}"));
          display = clampStr(String(p.display_name || p.name || "(no name)"), 120);
          name = clampStr(String(p.name || ""), 80);
          picture = sanitizeImageUrl(typeof p.picture === "string" ? p.picture : "");
          profileCache.set(hex, p);
        }catch{}
      }

      prevAvatar.innerHTML = "";
      prevAvatar.appendChild(makeImg(picture || makeFallback("#2563eb")));

      prevDisplay.textContent = display;
      prevHandle.textContent = name ? "@" + name : "@(unknown)";
      prevNpub.textContent = safeShort(npubStr, 60);
      prevNpub.setAttribute("data-hex", hex);

      previewBox.style.display = "block";
      addBtn.disabled = false;

      addDraft = { hex, npub: npubStr, profile: { display, name, picture } };
    });

    addBtn.addEventListener("click", async () => {
      if(!addDraft.hex) return;
      const hex = addDraft.hex;

      const exists = state.entries.some(e => e.hex === hex && !e.pendingDelete);
      if(exists){ alert("追加済みです（同一公開鍵）。"); return; }
      if(state.entries.length >= LIMITS.maxEntries){ alert("上限（1,000件）に達しています。"); return; }

      // ★要件：petname 未入力なら空欄（自動補完しない）
      const pet = clampStr((petnameInput.value || "").trim(), LIMITS.maxPetname);

      state.entries.push({
        hex,
        npub: addDraft.npub || safeNpub(hex),
        display: addDraft.profile?.display || "(loading...)",
        name: addDraft.profile?.name || "",
        avatar: sanitizeImageUrl(addDraft.profile?.picture || ""),
        petname: pet,
        relayHint: "",
        isPrivate: false,
        pendingDelete: false
      });

      await fetchProfilesForEntries();
      markDirty(true);
      renderEditAll();
      resetAddModal();
      closeModal("addModal");
    });

    function resetNewListModal(){ newDInput.value=""; newTitleInput.value=""; newDescInput.value=""; }

    createNewListBtn.addEventListener("click", async () => {
      const d = clampStr((newDInput.value || "").trim(), LIMITS.maxTitle);
      const title = clampStr((newTitleInput.value || "").trim(), LIMITS.maxTitle);
      const desc = clampStr((newDescInput.value || "").trim(), LIMITS.maxDesc);

      if(!d){ alert("d は必須です。"); return; }
      if(existingDs.has(d)){ alert("同じ d のリストが既に存在します。別の d を指定してください。"); return; }

      existingDs.add(d);
      resetNewListModal();
      closeModal("newListModal");
      await openEditorEmpty(d, title, desc);
    });

    titleInput.addEventListener("input", () => { state.title = clampStr(titleInput.value, LIMITS.maxTitle); markDirty(true); });
    descInput.addEventListener("input", () => { state.description = clampStr(descInput.value, LIMITS.maxDesc); markDirty(true); });
    dInput.addEventListener("input", () => { state.d = clampStr(dInput.value.trim(), LIMITS.maxTitle); markDirty(true); dTagChip.textContent = "d: " + (state.d || "-"); });

    relayInput.addEventListener("input", () => {
      const normalized = normalizeRelayUrls(relayInput.value);
      relayInput.value = normalized.join("\n");
      debugLog("relayInput normalized", normalized);
    });

    backBtn.addEventListener("click", () => { if(screenEdit.classList.contains("active")){ switchScreen("list"); markDirty(false); } });
    refreshListsBtn.addEventListener("click", async () => { await loadAllLists(); });

    newListBtn.addEventListener("click", () => { if(!pkHex){ alert("未ログインです。"); return; } openModal("newListModal"); newDInput.focus(); });
    closeNewListBtn.addEventListener("click", () => { resetNewListModal(); closeModal("newListModal"); });
    cancelNewListBtn.addEventListener("click", () => { resetNewListModal(); closeModal("newListModal"); });

    focusSettingsBtn.addEventListener("click", () => { document.getElementById("settingsPanelEdit").scrollIntoView({behavior:"smooth", block:"start"}); titleInput.focus(); });

    openAddBtn.addEventListener("click", () => openModal("addModal"));
    openAddBtn2.addEventListener("click", () => openModal("addModal"));
    closeAddBtn.addEventListener("click", () => { resetAddModal(); closeModal("addModal"); });
    cancelAddBtn.addEventListener("click", () => { resetAddModal(); closeModal("addModal"); });

    publishBtn.addEventListener("click", () => publishNow());
    publishBtn2.addEventListener("click", () => publishNow());

    openDeleteBtn.addEventListener("click", () => openDeleteListModal());

    closePublishBtn.addEventListener("click", () => closeModal("publishModal"));
    closePublishBtn2.addEventListener("click", () => closeModal("publishModal"));
    closeDeleteBtn.addEventListener("click", () => closeModal("deleteListModal"));
    closeDeleteBtn2.addEventListener("click", () => closeModal("deleteListModal"));

    loginBtn.addEventListener("click", async () => {
      try{
        const nsec = (nsecInput.value || "").trim();
        if(!nsec) throw new Error("nsec が空です");

        sk = bech32ToSk(nsec);
        pkHex = getPublicKey(sk);
        npub = pubkeyToNpub(pkHex);

        pubkeyChip.textContent = "pubkey: " + safeShort(pkHex, 18);
        npubChip.textContent = "npub: " + safeShort(npub, 22);

        setRelayUrls(BOOTSTRAP_RELAYS);
        setNetStatus("kind:10002 取得中…");
        await loadKind10002Relays();

        const initial = (initialD.value || "").trim();
        hideLogin();

        setNetStatus("kind:30000 一覧取得中…");
        await loadAllLists();
        setNetStatus(`接続先: ${getRelayUrls().length} relays`);

        if(initial){
          const it = listIndex.get(initial);
          if(it?.event) await openEditorFromEvent(it.event);
          else await openEditorEmpty(clampStr(initial, LIMITS.maxTitle), initial, "");
        }else{
          switchScreen("list");
        }
      }catch(e){
        alert(e?.message || String(e));
      }
    });

    function svgAvatar(color, letter){
      return `
      <svg xmlns="http://www.w3.org/2000/svg" width="96" height="96">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="${color}" stop-opacity="0.92"/>
            <stop offset="1" stop-color="#ffffff" stop-opacity="0.92"/>
          </linearGradient>
        </defs>
        <rect width="96" height="96" rx="22" fill="url(#g)"/>
        <circle cx="48" cy="40" r="18" fill="rgba(255,255,255,.7)"/>
        <rect x="22" y="62" width="52" height="20" rx="10" fill="rgba(255,255,255,.75)"/>
        <text x="48" y="47" text-anchor="middle" font-family="ui-sans-serif, system-ui" font-weight="900" font-size="18" fill="rgba(17,24,39,.90)">${letter}</text>
      </svg>`;
    }

    setRelayUrls(BOOTSTRAP_RELAYS);
    switchScreen("list");
    updateDirtyUI();
    showLogin();
    debugLog("boot", { bootstrap_relays: BOOTSTRAP_RELAYS });
  </script>
</body>
</html>